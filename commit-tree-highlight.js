/**
 * GitLab Commit Tree Syntax Highlighting Module
 * @fileoverview Functions for syntax highlighting code with Highlight.js
 * @module commit-tree-highlight
 */

/**
 * Applies syntax highlighting to a line of code
 * @param {string} content - Content of the line
 * @param {string} fileExt - File extension (e.g., 'js', 'py', 'vue')
 * @returns {string} HTML with syntax highlighting
 */
export function highlightCode(content, fileExt) {
    if (!hljs || !fileExt || !content.trim()) {
        return escapeHtml(content);
    }

    registerOmnisLanguage();
    
    if (!hljs.getLanguage(fileExt)) {
        return escapeHtml(content);
    }

    try {
        const result = hljs.highlight(content, { 
            language: fileExt,
            ignoreIllegals: true 
        });
        return result.value;
    } catch (e) {
        return escapeHtml(content);
    }
}

/**
 * Escapes HTML special characters
 * @param {string} text - Text to escape
 * @returns {string} Escaped HTML
 */
export function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

/**
 * Registers the Omnis Studio language definition with Highlight.js
 */
function registerOmnisLanguage() {
    if (typeof hljs === 'undefined' || hljs.getLanguage('omh')) {
        return;
    }

    hljs.registerLanguage('omh', function(hljs) {
        const KEYWORDS_CONTROL = [
            'Add line to list',
            'Begin',
            'Begin critical block',
            'Begin print job',
            'Begin reversible block',
            'Begin statement',
            'Begin text block',
            'Break to end of loop',
            'Break to end of switch',
            'Breakpoint',
            'Call',
            'Call DLL',
            'Call external routine',
            'Cancel async method',
            'Cancel message',
            'Cancel prepare for update',
            'Case',
            'Clear all files',
            'Clear line in list',
            'Clear main & connected',
            'Clear main file',
            'Clear range of fields',
            'Clear selected files',
            'Clear trace log',
            'Close trace log',
            'Close working message',
            'Context help',
            'Continue to next loop',
            'Default',
            'Delete',
            'Delete line in list',
            'Do',
            'Do async method',
            'Do code method',
            'Do inherited',
            'Do method',
            'Else',
            'Else If',
            'Else If calculation',
            'Else If flag false',
            'Else If flag true',
            'End',
            'End For',
            'End If',
            'End Switch',
            'End While',
            'End critical block',
            'End print job',
            'End reversible block',
            'End statement',
            'End text block',
            'Enter data',
            'Find',
            'Find first',
            'Find next',
            'Find previous',
            'For',
            'For each line in list',
            'For each row in list',
            'For field value',
            'If',
            'Insert',
            'Insert line in list',
            'Jump to start of loop',
            'Load',
            'Load from list',
            'No/Yes message',
            'OK message',
            'On',
            'On default',
            'On error',
            'Open trace log',
            'Prepare for edit',
            'Prepare for import from file',
            'Prepare for import from port',
            'Prepare for insert',
            'Prepare for print',
            'Prepare for update',
            'Prompt for input',
            'Quit Omnis',
            'Quit all event handlers',
            'Quit all if canceled',
            'Quit all methods',
            'Quit event handler',
            'Quit method',
            'Redraw',
            'Redraw menus',
            'Redraw toolbar',
            'Redraw working message',
            'Repeat',
            'Return',
            'Returns',
            'Save',
            'Send to trace log',
            'Set current list',
            'Set main file',
            'Set main file name',
            'Sound bell',
            'Start server',
            'Stop server',
            'Switch',
            'Until',
            'Until calculation',
            'Until flag false',
            'Until flag true',
            'Update files',
            'Update files if flag set',
            'While',
            'While calculation',
            'While flag false',
            'While flag true',
            'Working message',
            'Yes/No message',
            'Yield to other threads',
            'and',
            'as',
            'from',
            'in',
            'is',
            'mod',
            'not',
            'or',
            'step',
            'to',
            'with'
        ];

        const KEYWORDS_COMMANDS = [
            'Accept advise requests',
            'Accept commands',
            'Accept field requests',
            'Accept field values',
            'Advise on OK',
            'Advise on find/next/previous',
            'Advise on redraw',
            'Begin statement',
            'Bring window instance to front',
            'Build column names',
            'Build export format list',
            'Build externals list',
            'Build field names list',
            'Build file list',
            'Build indexes',
            'Build installed menu list',
            'Build list columns list',
            'Build list from file',
            'Build menu list',
            'Build open window list',
            'Build report list',
            'Build search list',
            'Build window instance',
            'Build window list',
            'CGIDecode',
            'CGIEncode',
            'Calculate',
            'Call',
            'Call DLL',
            'Call external routine',
            'Cancel advises',
            'Cancel message',
            'Change user password',
            'Change working directory',
            'Check data',
            'Check menu line',
            'Clear DDE channel item names',
            'Clear all files',
            'Clear check data log',
            'Clear data',
            'Clear list',
            'Clear main & connected',
            'Clear main file',
            'Clear method stack',
            'Clear range of fields',
            'Clear reference',
            'Clear search class',
            'Clear selected files',
            'Clear sort fields',
            'Clear timer method',
            'Close DDE channel',
            'Close all designs',
            'Close all windows',
            'Close check data log',
            'Close data file',
            'Close design',
            'Close file',
            'Close import file',
            'Close library',
            'Close lookup file',
            'Close other windows',
            'Close port',
            'Close print or export file',
            'Close task instance',
            'Close top window',
            'Close window instance',
            'Close working message',
            'Context help',
            'Copy file',
            'Copy list definition',
            'Copy to clipboard',
            'Create data file',
            'Create directory',
            'Create file',
            'Create library',
            'Cut to clipboard',
            'Define list from table',
            'Define schema from table',
            'Delete directory',
            'Delete file',
            'Disable all menus and toolbars',
            'Disable menu line',
            'Do',
            'Drop indexes',
            'Enable all menus and toolbars',
            'Enable menu line',
            'End import',
            'End statement',
            'Export data',
            'FTPClientWorker',
            'FileOps',
            'Get column names',
            'Get directory contents',
            'Get file info',
            'Get statement',
            'Get text block',
            'HTTPClientWorker',
            'HTTPHeader',
            'HTTPParse',
            'HTTPPost',
            'HTTPServerWorker',
            'Hide docking area',
            'IMAPClientWorker',
            'Import data',
            'Install menu',
            'Install toolbar',
            'JSWorker',
            'JSONGenerate',
            'JSONParse',
            'JavaScript:',
            'JavaWorker',
            'Launch program',
            'Line:',
            'Load external',
            'Load list from table',
            'Load page setup',
            'Logoff from host',
            'Logon to host',
            'Maximize window instance',
            'Merge list',
            'Minimize window instance',
            'Move file',
            'No/Yes message',
            'OAUTH2Worker',
            'OEXIF',
            'OHTTP',
            'OJSON',
            'OK message',
            'OREGEX',
            'OSQLXML',
            'OSSL',
            'OW3',
            'OXML',
            'OZip',
            'Open DDE channel',
            'Open check data log',
            'Open data file',
            'Open file',
            'Open import file',
            'Open library',
            'Open lookup file',
            'Open port',
            'Open task instance',
            'Open window instance',
            'Optimize method',
            'Paste from clipboard',
            'Popup menu',
            'Popup menu from list',
            'Prepare for import from file',
            'Prepare for import from port',
            'Print record',
            'Print report',
            'Print report from disk',
            'Print report from memory',
            'Print top window',
            'Prompt for destination',
            'Prompt for input',
            'Prompt for page setup',
            'Prompt for port name',
            'Prompt for print or export file',
            'PythonWorker',
            'Read file',
            'Rebuild indexes',
            'Redefine list',
            'Redraw toolbar',
            'Redraw working message',
            'Register DLL',
            'Reinitialize search class',
            'Remove all menus',
            'Remove final menu',
            'Remove menu',
            'Remove toolbar',
            'Replace standard Edit menu',
            'Replace standard File menu',
            'Request advises',
            'Request data',
            'Returns',
            'SQL:',
            'SMTPClientWorker',
            'SQLWorker',
            'Save list to table',
            'Search list',
            'Select printer',
            'Send command',
            'Send data',
            'Send to a window field',
            'Send to clipboard',
            'Send to file',
            'Send to page preview',
            'Send to port',
            'Send to printer',
            'Send to screen',
            'Set \'About...\' method',
            'Set DDE channel item name',
            'Set DDE channel number',
            'Set Omnis window title',
            'Set current session',
            'Set database version',
            'Set file attributes',
            'Set file name',
            'Set hostname',
            'Set import file name',
            'Set main file',
            'Set password',
            'Set port name',
            'Set port parameters',
            'Set print or export file name',
            'Set reference',
            'Set report name',
            'Set search as calculation',
            'Set search name',
            'Set server mode',
            'Set sort field',
            'Set timer method',
            'Set top window title',
            'Set username',
            'Show \'About...\' window',
            'Show Omnis maximized',
            'Show Omnis minimized',
            'Show Omnis normal',
            'Show docking area',
            'Sort list',
            'Sound bell',
            'Sta:',
            'Standard menu command',
            'Start program maximized',
            'Start program minimized',
            'Start program normal',
            'Start session',
            'Startup_Task',
            'StringTable',
            'Swap lists',
            'TCPClose',
            'TCPConnect',
            'TCPPing',
            'TCPReceive',
            'TCPSend',
            'TCPSocket',
            'Test data with search class',
            'Test for library open',
            'Test for menu installed',
            'Test for menu line checked',
            'Test for menu line enabled',
            'Test for program open',
            'Test for window open',
            'Test if file exists',
            'Test if list line selected',
            'Test if running in background',
            'Text:',
            'Uncheck menu line',
            'Working message',
            'Write file',
            'XMLGenerate',
            'XMLParse',
            'Yes/No message'
        ];

        const TYPES = [
            'Binary',
            'Boolean',
            'Character',
            'Date',
            'DateTime',
            'Floatdp',
            'Integer',
            'ItemReference',
            'List',
            'Longint',
            'National',
            'Number',
            'Object',
            'Picture',
            'Row',
            'Shortint',
            'Time'
        ];

        const CONSTANTS = [
            'kAlignBottom',
            'kAlignCenter',
            'kAlignLeft',
            'kAlignMiddle',
            'kAlignRight',
            'kAlignTop',
            'kAscending',
            'kBinary',
            'kBlack',
            'kBlue',
            'kBold',
            'kBoolean',
            'kBorderDouble',
            'kBorderLowered',
            'kBorderNone',
            'kBorderRaised',
            'kBorderSingle',
            'kBrown',
            'kCenterJst',
            'kCentiSecond',
            'kCharacter',
            'kCyan',
            'kDarkBlue',
            'kDarkCyan',
            'kDarkGray',
            'kDarkGreen',
            'kDarkMagenta',
            'kDarkRed',
            'kDarkYellow',
            'kDate',
            'kDateTime',
            'kDay',
            'kDescending',
            'kEventPriorityHigh',
            'kEventPriorityLow',
            'kEventPriorityNormal',
            'kFalse',
            'kFetchAll',
            'kFetchOne',
            'kFileCreate',
            'kFileReadOnly',
            'kFileReadWrite',
            'kFloatdp',
            'kFullJst',
            'kGray',
            'kGreen',
            'kHelpContents',
            'kHelpContext',
            'kHelpContextMode',
            'kHelpContextPopup',
            'kHelpQuit',
            'kHour',
            'kInteger',
            'kItalic',
            'kItemref',
            'kJSErrorTextPosHidden',
            'kJSErrorTextPosRight',
            'kJSErrorTextPosUnder',
            'kLeftJst',
            'kLightGray',
            'kList',
            'kListDeleteSelected',
            'kListKeepSelected',
            'kLongint',
            'kMagenta',
            'kMenuChecked',
            'kMenuDisabled',
            'kMenuEnabled',
            'kMenuSeparator',
            'kMenuUnchecked',
            'kMinute',
            'kMonth',
            'kNational',
            'kNavigateFirst',
            'kNavigateLast',
            'kNavigateNext',
            'kNavigatePrevious',
            'kNull',
            'kNumber',
            'kORegExCaseInsensitive',
            'kORegExMatchNotNull',
            'kOW3httpDelete',
            'kOW3httpGet',
            'kOW3httpHead',
            'kOW3httpMultiPartFormData',
            'kOW3httpPatch',
            'kOW3httpPost',
            'kOW3httpPut',
            'kObject',
            'kOrange',
            'kPalette',
            'kPicture',
            'kPink',
            'kPlain',
            'kQuarter',
            'kRed',
            'kRightJst',
            'kRow',
            'kSMTPAuthCramMD5',
            'kSMTPAuthLogin',
            'kSMTPAuthNone',
            'kSMTPAuthPlain',
            'kSQLModeRead',
            'kSQLModeReadWrite',
            'kSQLModeWrite',
            'kScrollAlways',
            'kScrollAuto',
            'kScrollNone',
            'kSecond',
            'kSessionStatusLoggedOff',
            'kSessionStatusLoggedOn',
            'kShortint',
            'kSimplechar',
            'kStrikethrough',
            'kTime',
            'kTrue',
            'kUnderline',
            'kUniTypeAuto',
            'kUniTypeUTF16BE',
            'kUniTypeUTF16LE',
            'kUniTypeUTF8',
            'kWeek',
            'kWhite',
            'kWindowTypeModal',
            'kWindowTypeModeless',
            'kWindowTypePalette',
            'kWindowTypeWindow',
            'kYear',
            'kYellow'
        ];

        const PROPERTIES = [
            '$add', '$addafter', '$addbefore', '$allowclose', '$assign', '$average',
            '$backcolor', '$bobjs', '$bringtofront', '$callback', '$callbackinst',
            '$callmethod', '$canassign', '$cando', '$cclass', '$cfield', '$cinst',
            '$classes', '$clear', '$clib', '$close', '$cobj', '$cols', '$completed',
            '$components', '$construct', '$copydefinition', '$count', '$ctask',
            '$cwind', '$dataname', '$datas', '$define', '$definefromsqlclass',
            '$delete', '$destruct', '$enabled', '$errorcode', '$errortext', '$event',
            '$execdirect', '$execute', '$external', '$extobjects', '$fetch', '$files',
            '$findname', '$first', '$flags', '$fontname', '$fontsize', '$fontstyle',
            '$forecolor', '$fullname', '$getcols', '$geterrorcode', '$geterrortext',
            '$helpid', '$ident', '$imenus', '$init', '$insert', '$ireports', '$isa',
            '$issupercomponent', '$itasks', '$iwindows', '$last', '$libs', '$line',
            '$linecount', '$linemax', '$loadcols', '$logoff', '$logon', '$losefocus',
            '$makelist', '$makesubclass', '$maximum', '$menus', '$merge',
            '$methoderror', '$methodreturn', '$minimum', '$name', '$newstatement',
            '$next', '$nofatal', '$objects', '$objs', '$open', '$order', '$prefs',
            '$prepare', '$previous', '$recalculate', '$redefine', '$redraw', '$remove',
            '$reports', '$root', '$rowfetched', '$rows', '$run', '$search', '$select',
            '$selected', '$selfcontained', '$sendall', '$sendtoback', '$sessionname',
            '$setcallinginst', '$setfocus', '$sort', '$sqlstatement', '$start',
            '$stop', '$superclass', '$tasks', '$textcolor', '$title', '$tooltip',
            '$topwind', '$total', '$totc', '$update', '$usage', '$visible', '$windows'
        ];

        const FUNCTIONS = [
            'cVar', 'con', 'eval', 'fVar', 'flag', 'formatchunk', 'formatnumber',
            'formatstring', 'iVar', 'lVar', 'len', 'lookup', 'low', 'mid', 'oVar',
            'pVar', 'pick', 'pos', 'rVar', 'replace', 'replaceall', 'rgb', 'sys',
            'tVar', 'tot', 'upp'
        ];

        return {
            name: 'Omnis Studio',
            case_insensitive: false,
            keywords: {
                keyword: KEYWORDS_CONTROL.concat(KEYWORDS_COMMANDS),
                type: TYPES,
                literal: CONSTANTS,
                built_in: PROPERTIES.concat(FUNCTIONS)
            },
            contains: [
                hljs.COMMENT('#', '$'),
                {
                    className: 'comment',
                    begin: ';', end: '$'
                },
                hljs.QUOTE_STRING_MODE,
                {
                    className: 'number',
                    begin: '\\b0x[0-9a-fA-F]+\\b'
                },
                {
                    className: 'number',
                    begin: '\\b\\d+(\\.\\d+)?\\b'
                },
                {
                    className: 'variable',
                    begin: '\\$[a-zA-Z_][a-zA-Z0-9_]*'
                },
                {
                    className: 'operator',
                    begin: '(&|\\||\\+|-|\\*|/|=|<>|<=|>=|<|>)'
                }
            ]
        };
    });
}